#!/usr/bin/env bash

set -Eeuo pipefail
trap cleanup SIGINT SIGTERM ERR EXIT

usage() {
  cat <<EOF
Usage: $(basename "${BASH_SOURCE[0]}") [-h] [-v] <time_of_day>

Sets the macOS Tahoe wallpaper to a specific time of day variant.

Arguments:

time_of_day     One of: morning, day, evening, night

Available options:

-h, --help      Print this help and exit
-v, --verbose   Print script debug info
EOF
  exit
}

cleanup() {
  trap - SIGINT SIGTERM ERR EXIT
}

setup_colors() {
  if [[ -t 2 ]] && [[ -z "${NO_COLOR-}" ]] && [[ "${TERM-}" != "dumb" ]]; then
    NOFORMAT='\033[0m'
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    ORANGE='\033[0;33m'
    BLUE='\033[0;34m'
    PURPLE='\033[0;35m'
    CYAN='\033[0;36m'
    YELLOW='\033[1;33m'
  else
    NOFORMAT=''
    RED=''
    GREEN=''
    ORANGE=''
    BLUE=''
    PURPLE=''
    CYAN=''
    YELLOW=''
  fi
  # shellcheck disable=SC2034
  readonly NOFORMAT RED GREEN ORANGE BLUE PURPLE CYAN YELLOW
}

msg() {
  echo >&2 -e "${1-}"
}

die() {
  local msg="${1}"
  local code="${2-1}"
  msg "${msg}"
  exit "${code}"
}

parse_params() {
  while :; do
    case "${1-}" in
      -h | --help) usage ;;
      -v | --verbose) set -x ;;
      --no-color) NO_COLOR=1 ;;
      -?*) die "Unknown option: ${1}" ;;
      *) break ;;
    esac
    shift
  done

  args=(${1+"$@"})

  [[ ${#args[@]} -eq 0 ]] && usage

  return 0
}

parse_params ${1+"$@"}
setup_colors

if [ "$(uname)" != "Darwin" ]; then
  die "Can only set wallpaper on macOS"
fi

set_wallpaper() {
  local asset_id="${1}"
  local plist
  plist="${HOME}/Library/Application Support/com.apple.wallpaper/Store/Index.plist"
  local config_plist
  config_plist="$(mktemp).plist"

  cat >"${config_plist}" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" \
"http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>assetID</key>
    <string>${asset_id}</string>
</dict>
</plist>
EOF

  plutil -convert binary1 "${config_plist}"

  local config_data
  config_data="$(base64 <"${config_plist}")"
  rm "${config_plist}"

  plutil -convert xml1 "${plist}"

  plutil \
    -replace AllSpacesAndDisplays.Linked.Content.Choices.0.Configuration \
    -data "${config_data}" \
    "${plist}"
  plutil \
    -replace SystemDefault.Linked.Content.Choices.0.Configuration \
    -data "${config_data}" \
    "${plist}"

  plutil -convert binary1 "${plist}"

  killall WallpaperAgent 2>/dev/null || true
}

case "${args[0]}" in
  morning) set_wallpaper "B2FC91ED-6891-4DEB-85A1-268B2B4160B6" ;;
  day) set_wallpaper "4C108785-A7BA-422E-9C79-B0129F1D5550" ;;
  evening) set_wallpaper "52ACB9B8-75FC-4516-BC60-4550CFF3B661" ;;
  night) set_wallpaper "CF6347E2-4F81-4410-8892-4830991B6C5A" ;;
  *) die "Unknown time of day: ${args[0]}. Use: morning, day, evening, night" ;;
esac

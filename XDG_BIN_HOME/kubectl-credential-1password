#!/usr/bin/env bash

set -Eeuo pipefail
trap cleanup SIGINT SIGTERM ERR EXIT

usage() {
  cat <<EOF
Usage: $(basename "${BASH_SOURCE[0]}") [-h] [-v] [-a account] <vault/item>

kubectl exec credential plugin for 1Password.

Reads client-certificate and client-key fields from a 1Password item
and returns an ExecCredential JSON for kubectl.

Available options:

-a, --account   1Password account (default: dutchanalytics)
-h, --help      Print this help and exit
-v, --verbose   Print script debug info
EOF
  exit
}

cleanup() {
  trap - SIGINT SIGTERM ERR EXIT
}

setup_colors() {
  if [[ -t 2 ]] && [[ -z "${NO_COLOR-}" ]] && [[ "${TERM-}" != "dumb" ]]; then
    NOFORMAT='\033[0m'
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    ORANGE='\033[0;33m'
    BLUE='\033[0;34m'
    PURPLE='\033[0;35m'
    CYAN='\033[0;36m'
    YELLOW='\033[1;33m'
  else
    NOFORMAT=''
    RED=''
    GREEN=''
    ORANGE=''
    BLUE=''
    PURPLE=''
    CYAN=''
    YELLOW=''
  fi
  # shellcheck disable=SC2034
  readonly NOFORMAT RED GREEN ORANGE BLUE PURPLE CYAN YELLOW
}

msg() {
  echo >&2 -e "${1-}"
}

die() {
  local msg=${1}
  local code=${2-1} # default exit status 1
  msg "${msg}"
  exit "${code}"
}

parse_params() {
  ACCOUNT="${OP_ACCOUNT:-dutchanalytics}"

  while :; do
    case "${1-}" in
      -a | --account)
        ACCOUNT="${2-}"
        shift
        ;;
      -h | --help) usage ;;
      -v | --verbose) set -x ;;
      --no-color) NO_COLOR=1 ;;
      -?*) die "Unknown option: ${1}" ;;
      *) break ;;
    esac
    shift
  done

  args=("$@")

  [[ ${#args[@]} -eq 0 ]] && die "Missing required argument: <vault/item>"

  return 0
}

parse_params "${@}"
setup_colors

readonly REQUIRED_BINARIES=("op")
for bin in "${REQUIRED_BINARIES[@]}"; do
  if ! command -v "${bin}" >/dev/null 2>&1; then
    die "${bin} is required, exiting"
  fi
done

ITEM="${args[0]}"

CLIENT_CERT=$(
  op read "op://${ITEM}/client-certificate" --account="${ACCOUNT}" 2>/dev/null
) || die "${RED}Failed to read client-certificate from 1Password${NOFORMAT}"

CLIENT_KEY=$(
  op read "op://${ITEM}/client-key" --account="${ACCOUNT}" 2>/dev/null
) || die "${RED}Failed to read client-key from 1Password${NOFORMAT}"

# Base64 encode without line breaks (kubectl expects base64-encoded data)
CLIENT_CERT_B64=$(echo -n "${CLIENT_CERT}" | base64 | tr -d '\n')
CLIENT_KEY_B64=$(echo -n "${CLIENT_KEY}" | base64 | tr -d '\n')

# Output ExecCredential JSON
cat <<EOF
{
  "apiVersion": "client.authentication.k8s.io/v1",
  "kind": "ExecCredential",
  "status": {
    "clientCertificateData": "${CLIENT_CERT_B64}",
    "clientKeyData": "${CLIENT_KEY_B64}"
  }
}
EOF

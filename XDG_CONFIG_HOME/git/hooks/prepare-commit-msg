#!/usr/bin/env bash
#
# Generate commit message using aicommit2 and prepopulate the editor.

# Skip if aicommit2 or op is not installed
if ! command -v aicommit2 &>/dev/null || ! command -v op &>/dev/null; then
  exit 0
fi

export OP_ACCOUNT="my.1password.eu"
export OPENAI_API_KEY="op://Private/sgjddcuzvgu3qbpzqqw6tn5lw4/credential"

# Use local config if present and AICOMMIT_CONFIG_PATH not already set
if [[ -z "${AICOMMIT_CONFIG_PATH}" ]]; then
  local_config="$(git rev-parse --show-toplevel)/.config/aicommit2/config.ini"
  if [[ -f "${local_config}" ]]; then
    export AICOMMIT_CONFIG_PATH="${local_config}"
  fi
fi

op run -- aicommit2 --include-body --hook-mode "$@"

# Strip aicommit2 banner comments and leading blank lines
# Insert scissors line before diff so git strips it from final message
COMMIT_MSG_FILE="${1}"
if [[ -f "${COMMIT_MSG_FILE}" ]]; then
  sed -i '' \
    -e '/^# ðŸ¤– Generated by aicommit2/d' \
    -e '/^# -\{20,\}/d' \
    -e '/^# How to use:/d' \
    -e '/^# [0-9]\. /d' \
    -e '/^# ðŸ“ Generated commit message:/d' \
    -e '/^diff --git/i\
# ------------------------ >8 ------------------------' \
    "${COMMIT_MSG_FILE}"
  sed -i '' '1,/[^[:space:]]/{/^$/d;}' "${COMMIT_MSG_FILE}"
fi
